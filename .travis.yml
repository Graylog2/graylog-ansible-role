---
branches:
  only:
    - master

services:
  - docker

env:
  - distro: centos7_21
    init: /usr/sbin/init
    run_opts: '-it --privileged -v $PWD:/role:ro -v /sys/fs/cgroup:/sys/fs/cgroup:ro -d'
  - distro: centos7_22
    init: /usr/sbin/init
    run_opts: '-it --privileged -v $PWD:/role:ro -v /sys/fs/cgroup:/sys/fs/cgroup:ro -d'
  - distro: wheezy_21
    init: ""
    run_opts: '-it -v $PWD:/role'
  - distro: wheezy_22
    init: ""
    run_opts: '-it -v $PWD:/role'
  - distro: trusty_21
    init: ""
    run_opts: '-it -v $PWD:/role'
  - distro: trusty_22
    init: ""
    run_opts: '-it -v $PWD:/role'
  - distro: xenial_21
    init: /sbin/init
    run_opts: '-it --privileged -v $PWD:/role:ro -v /sys/fs/cgroup:/sys/fs/cgroup:ro -d'
  - distro: xenial_22
    init: /sbin/init
    run_opts: '-it --privileged -v $PWD:/role:ro -v /sys/fs/cgroup:/sys/fs/cgroup:ro -d'

before_script:
  - >
    docker build -t graylog-ansible-role-${distro}
    -f tests/support/${distro}.Dockerfile tests/support

script:
  - docker run ${run_opts} --name ${distro} graylog-ansible-role-${distro} ${init}
  - DOCKER_CONTAINER_ID=$(docker ps --filter name=${distro})
  - docker exec -it $DOCKER_CONTAINER_ID /bin/bash -xec "bash -x run-tests.sh"
